<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fixo · Registro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f9fc;
      --text:#1f2937;
      --muted:#6b7280;
      --input:#e9eef5;
      --border:#dbe3ef;
      --primary:#1d8cff;
      --primary-600:#1876d9;
      --link:#0f60e6;
      --ok:#166534;
      --okbg:#dcfce7;
      --okbd:#bbf7d0;
      --err:#b91c1c;
      --errbg:#fee2e2;
      --errbd:#fecaca;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      display:grid; place-items:center;
    }
    .container{ width:100%; max-width:360px; padding:28px 16px 36px; }
    .logo{ display:block; margin:12px auto 8px; width:120px; height:auto; }
    h1{ font-size:22px; font-weight:700; text-align:center; margin:12px 0 8px; }
    .subtitle{ text-align:center; color:var(--muted); font-size:14px; line-height:1.4; margin:0 6px 22px; }
    label{ display:block; font-size:14px; font-weight:600; margin:10px 4px 6px; }
    .input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--input); outline:none; font-size:15px; color:var(--text);
      transition:border-color .2s, box-shadow .2s;
    }
    .input:focus{ border-color:#bcd6ff; box-shadow:0 0 0 4px rgba(29,140,255,.15); background:#fff; }
    .row{ display:flex; gap:10px; }
    .segmented{ display:flex; gap:10px; }
    .segmented button{
      flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#fff; color:var(--text); cursor:pointer; font-weight:600;
    }
    .segmented button.active{
      border-color: var(--primary); color:#fff;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      box-shadow:0 6px 14px rgba(29,140,255,.25);
    }
    .btn{
      width:100%; margin-top:14px; padding:12px 16px; border:none; border-radius:12px; cursor:pointer;
      background:var(--primary); color:#fff; font-size:15px; font-weight:700;
      box-shadow:0 8px 16px rgba(29,140,255,.25); transition:filter .2s, transform .06s;
    }
    .btn:hover{filter:saturate(1.05)}
    .btn:active{transform:translateY(1px)}
    .footer{ text-align:center; margin-top:14px; font-size:14px; color:var(--muted); }
    .footer a{ color:var(--link); text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }
    .alert{ margin:8px 0 0; font-size:14px; padding:10px 12px; border-radius:10px; display:none; }
    .alert.ok{ display:block; color:var(--ok); background:var(--okbg); border:1px solid var(--okbd); }
    .alert.err{ display:block; color:var(--err); background:var(--errbg); border:1px solid var(--errbd); }
    .terms{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; margin-top:6px; }
    .terms input{ width:16px; height:16px; accent-color:var(--primary); }
  </style>
</head>
<body>
  <div class="container">
    <!-- Reemplazá el src por tu logo -->
    <img class="logo" src="https://i.imgur.com/Tf8m1pW.png" alt="Fixo" />

    <h1>Crea tu cuenta</h1>
    <p class="subtitle">Encontrá técnicos confiables cerca de vos en Uruguay.</p>

    <form id="form" novalidate>
      <label for="fullname">Nombre y apellido</label>
      <input id="fullname" name="fullname" type="text" class="input" placeholder="Nombre Apellido" required />

      <label for="email">Email</label>
      <input id="email" name="email" type="email" class="input" placeholder="correo@ejemplo.com" required />

      <label for="password">Contraseña</label>
      <input id="password" name="password" type="password" class="input" placeholder="Mínimo 6 caracteres" minlength="6" required />

      <label for="phone">Teléfono</label>
      <input id="phone" name="phone" type="tel" class="input" placeholder="+598 92 123 123" />

      <label>Rol</label>
      <div class="segmented" role="group" aria-label="Seleccionar rol">
        <button type="button" id="btnCliente" class="active" data-rol="cliente">Cliente</button>
        <button type="button" id="btnProfesional" data-rol="profesional">Profesional</button>
      </div>

      <label for="city">Ciudad (opcional)</label>
      <input id="city" name="city" type="text" class="input" placeholder="Montevideo" />

      <div class="terms">
        <input id="terms" type="checkbox" required />
        <label for="terms">Acepto los <a href="#" onclick="event.preventDefault()">Términos</a> y la <a href="#" onclick="event.preventDefault()">Privacidad</a>.</label>
      </div>

      <button class="btn" id="submitBtn" type="submit">Crear cuenta</button>
      <div id="alert" class="alert"></div>
    </form>

    <p class="footer">
      ¿Ya tenés cuenta? <a href="/login.html">Iniciar sesión</a>
    </p>
  </div>

  <script>
    // ⚠️ Cambiá esto si tu backend corre en otra URL/puerto
    const API_BASE = 'http://localhost:3000';

    const form = document.getElementById('form');
    const fullnameEl = document.getElementById('fullname');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const phoneEl = document.getElementById('phone');
    const cityEl = document.getElementById('city');
    const alertEl = document.getElementById('alert');
    const submitBtn = document.getElementById('submitBtn');

    const btnCliente = document.getElementById('btnCliente');
    const btnProfesional = document.getElementById('btnProfesional');
    let rol = 'cliente';

    function setRol(newRol){
      rol = newRol;
      btnCliente.classList.toggle('active', newRol === 'cliente');
      btnProfesional.classList.toggle('active', newRol === 'profesional');
    }
    btnCliente.addEventListener('click', ()=> setRol('cliente'));
    btnProfesional.addEventListener('click', ()=> setRol('profesional'));

    function showAlert(msg, ok=false){
      alertEl.className = 'alert ' + (ok ? 'ok' : 'err');
      alertEl.textContent = msg;
    }
    function clearAlert(){ alertEl.className='alert'; alertEl.textContent=''; }

    function splitName(fullname){
      const parts = fullname.trim().split(/\s+/);
      const nombre = parts.shift() || '';
      const apellido = parts.join(' ') || '';
      return { nombre, apellido };
    }

    async function register(payload){
      const res = await fetch(API_BASE + '/api/register', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || 'No se pudo crear la cuenta');
      return data; // { token, usuario }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearAlert();

      if(!form.reportValidity()){
        showAlert('Completá los campos requeridos.');
        return;
      }

      const { nombre, apellido } = splitName(fullnameEl.value);
      if(!nombre || !apellido){
        showAlert('Ingresá nombre y apellido.');
        return;
      }

      const email = emailEl.value.trim();
      const password = passEl.value;
      const telefono = phoneEl.value.trim();
      const ciudad = cityEl.value.trim();

      const payload = {
        nombre,
        apellido,
        email,
        password,     // el backend la hashea (bcrypt)
        telefono,
        ciudad,       // opcional, por si tu endpoint lo usa para una ubicación inicial
        rol           // 'cliente' | 'profesional'
      };

      submitBtn.disabled = true; submitBtn.textContent = 'Creando...';

      try{
        const data = await register(payload);

        // Guardar token/usuario
        localStorage.setItem('pds_token', data.token);
        localStorage.setItem('pds_user', JSON.stringify(data.usuario));

        showAlert('¡Cuenta creada con éxito! Redirigiendo…', true);
        setTimeout(()=> location.href = '/dashboard.html', 800);
      }catch(err){
        showAlert(err.message || 'Error al registrar.');
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Crear cuenta';
      }
    });
  </script>
</body>
</html>
